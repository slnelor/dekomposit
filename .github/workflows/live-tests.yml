name: Live Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

concurrency:
  group: live-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  live-smoke:
    name: Live Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: live-tests
    env:
      CURRENT_API_KEY: GEMINI_API_KEY
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      LLM_MODEL: gemini-flash-lite-latest
      LLM_SERVER: https://generativelanguage.googleapis.com/v1beta/openai/

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Preflight (require secret)
        id: preflight
        run: |
          if [ -z "${GEMINI_API_KEY}" ]; then
            echo "No GEMINI_API_KEY configured for this environment. Skipping live tests."
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_run=true" >> "$GITHUB_OUTPUT"

      - name: Setup Python 3.12
        if: steps.preflight.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install test dependencies
        if: steps.preflight.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv pydantic openai httpx pytest pytest-asyncio

      - name: Run live tests
        if: steps.preflight.outputs.should_run == 'true'
        run: |
          pytest -m live -q --junitxml=test-results/live.xml

      - name: Upload live test results
        if: always() && steps.preflight.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: live-test-results
          path: test-results/live.xml
          if-no-files-found: ignore
